<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API Settings</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            color: #333;
            line-height: 1.6;
        }

        h1, h2, h3 {
            color: #2c3e50;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #2c3e50;
        }

        input,
        textarea {
            width: 100%;
            padding: 10px;
            box-sizing: border-box;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }

        .slider-container {
            display: flex;
            align-items: center;
            margin-top: 5px;
        }

        .slider {
            flex-grow: 1;
            margin-right: 15px;
            height: 8px;
        }

        .slider-value {
            width: 60px;
            font-weight: bold;
            text-align: center;
        }

        button {
            background-color: #4CAF50;
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin-right: 12px;
            margin-bottom: 12px;
            transition: background-color 0.3s;
        }

        button:hover {
            background-color: #45a049;
        }

        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }

        #fileCount {
            font-weight: bold;
            color: #2980b9;
        }

        .status-message {
            margin-top: 20px;
            padding: 15px;
            border-radius: 4px;
            font-size: 16px;
        }

        .success {
            background-color: #dff0d8;
            color: #3c763d;
            border: 1px solid #d6e9c6;
        }

        .error {
            background-color: #f2dede;
            color: #a94442;
            border: 1px solid #ebccd1;
        }

        .warning {
            background-color: #fcf8e3;
            color: #8a6d3b;
            border: 1px solid #faebcc;
        }

        .delete-button {
            background-color: #f44336;
        }

        .delete-button:hover {
            background-color: #d32f2f;
        }

        .fetch-button {
            background-color: #2196F3;
        }

        .fetch-button:hover {
            background-color: #0b7dda;
        }

        .indexed-files {
            margin-top: 30px;
            border: 1px solid #ddd;
            padding: 20px;
            border-radius: 4px;
            background-color: #f9f9f9;
        }

        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #eee;
            background-color: white;
            margin-bottom: 5px;
            border-radius: 4px;
        }

        .file-item:last-child {
            border-bottom: none;
        }

        .file-item button {
            padding: 6px 12px;
            margin: 0;
        }

        .file-info {
            display: flex;
            flex-direction: column;
        }

        .file-name {
            font-weight: bold;
        }

        .file-metadata {
            font-size: 12px;
            color: #666;
        }

        .number_of_files {
            padding: 10px;
            font-size: 16px;
            color: #2980b9;
            text-align: center;
            background-color: #ecf0f1;
            border-radius: 4px;
            margin-bottom: 15px;
        }

        /* Timer styles */
        .timer-container {
            margin-top: 30px;
            padding: 20px;
            background-color: #f5f5f5;
            border-radius: 6px;
            border: 1px solid #ddd;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .timer-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .timer-display {
            font-size: 32px;
            font-weight: bold;
            text-align: center;
            margin: 15px 0;
            color: #2c3e50;
            font-family: monospace;
        }

        .progress-container {
            margin: 15px 0;
            background-color: #e0e0e0;
            border-radius: 4px;
            height: 20px;
            overflow: hidden;
            border: 1px solid #ccc;
        }

        .progress-bar {
            height: 100%;
            background-color: #4CAF50;
            width: 0%;
            transition: width 0.5s ease-in-out;
        }

        .fetch-status {
            margin-top: 15px;
            font-size: 16px;
            text-align: center;
        }

        .control-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
        }

        .settings-card {
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .settings-card h2 {
            margin-top: 0;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }

        .file-count-badge {
            display: inline-block;
            background-color: #3498db;
            color: white;
            border-radius: 50px;
            padding: 5px 10px;
            font-size: 14px;
            margin-left: 10px;
        }

        .section-divider {
            border-top: 1px solid #ddd;
            margin: 30px 0;
        }

        .rag-status-indicator {
            position: fixed;
            top: 10px;
            right: 10px;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            z-index: 1000;
            transition: all 0.3s ease;
            display: none;
        }

        .rag-active {
            background-color: #4CAF50;
            color: white;
        }

        .rag-pending {
            background-color: #ff9800;
            color: white;
        }

        /* Responsive design adjustments */
        @media (max-width: 768px) {
            body {
                padding: 15px;
            }
            
            button {
                width: 100%;
                margin-bottom: 10px;
                margin-right: 0;
            }
            
            .control-buttons {
                flex-direction: column;
            }
            
            .timer-header {
                flex-direction: column;
                align-items: stretch;
            }
            
            .timer-header button {
                margin-top: 10px;
            }
        }
    </style>
</head>

<body>
    <h1>API Settings</h1>

    <!-- RAG Status Indicator -->
    <div id="ragStatusIndicator" class="rag-status-indicator"></div>

    <div class="settings-card">
        <h2>API Configuration</h2>
        <form id="apiSettingsForm" enctype="multipart/form-data">
            <div class="form-group">
                <label for="apiKey">API Key:</label>
                <input type="password" id="apiKey" name="apiKey" placeholder="Paste your OpenAI API key here">
            </div>

            <div class="form-group">
                <label for="temperature">Temperature: <span id="temperatureValue">0.7</span></label>
                <div class="slider-container">
                    <input type="range" id="temperature" name="temperature" class="slider" min="0" max="1" step="0.01"
                        value="0.7">
                </div>
                <small>Lower values (closer to 0) make responses more focused and deterministic. Higher values (closer to 1) make responses more creative and varied.</small>
            </div>

            <div class="form-group">
                <label for="maxTokens">Max Tokens: <span id="maxTokensValue">1000</span></label>
                <div class="slider-container">
                    <input type="range" id="maxTokens" name="maxTokens" class="slider" min="100" max="4000" step="50"
                        value="1000">
                </div>
                <small>Controls the maximum length of the model's response. Higher values allow for longer responses.</small>
            </div>

            <div class="form-group">
                <label for="numberOfFiles">Maximum Files to Process: <span id="numberOfFilesValue">100</span></label>
                <div class="slider-container">
                    <input type="range" id="numberOfFiles" name="numberOfFiles" class="slider" min="10" max="500" step="10"
                        value="100">
                </div>
                <small>Sets the maximum number of files that can be processed at once.</small>
            </div>

            <div class="form-group">
                <label for="maxArticles">Maximum Articles to Fetch: <span id="maxArticlesValue">100</span></label>
                <div class="slider-container">
                    <input type="range" id="maxArticles" name="maxArticles" class="slider" min="10" max="500" step="10"
                        value="100">
                </div>
                <small>Sets the maximum number of articles that will be fetched during the search process.</small>
            </div>

            <button type="button" id="saveButton">Save Settings</button>
            <button type="button" id="homeButton">Return to Home</button>
        </form>
    </div>

    <div class="settings-card">
        <h2>File Upload</h2>
        <div class="form-group">
            <label for="fileUpload">Upload Files:</label>
            <input type="file" id="fileUpload" name="files[]" multiple>
            <p>Files selected: <span id="fileCount">0</span></p>
            <small>Upload text files, PDFs, and other supported document formats for indexing.</small>
        </div>
        <button type="button" id="uploadButton">Upload & Index Files</button>
    </div>
    
    <div class="settings-card">
        <h2>Article Fetching</h2>
        <div class="form-group">
            <label for="urls">URLs to Fetch (one per line):</label>
            <textarea id="urls" name="urls" rows="5" placeholder="Enter URLs here, one per line"></textarea>
            <small>Enter specific web page URLs to fetch and index their content.</small>
        </div>

        <div class="form-group">
            <label for="searchQuery">Search Query for Auto-Fetching Articles:</label>
            <input type="text" id="searchQuery" name="searchQuery" placeholder="Enter a search query for automatic article discovery">
            <small>The system will automatically search for and fetch articles related to this query.</small>
        </div>

        <div class="form-group">
            <label for="fetchDuration">Article Fetch Duration: <span id="fetchDurationDisplay">5 minutes</span></label>
            <div class="slider-container">
                <input type="range" id="fetchDuration" name="fetchDuration" class="slider" min="1" max="120" step="1"
                    value="5">
            </div>
            <small>Controls how long the automatic fetching process will run. Longer durations may collect more articles.</small>
        </div>

        <button type="button" id="fetchButton" class="fetch-button">Fetch Articles</button>
    </div>

    <div id="statusMessage" class="status-message" style="display: none;"></div>

    <!-- Timer container - will be shown when fetching starts -->
    <div class="timer-container" id="timerContainer" style="display: none;">
        <div class="timer-header">
            <h3>Article Fetch Progress</h3>
            <button id="cancelFetchButton" class="delete-button">Cancel Process</button>
        </div>
        <div class="timer-display" id="timerDisplay">05:00</div>
        <div class="progress-container">
            <div class="progress-bar" id="fetchProgressBar"></div>
        </div>
        <div class="fetch-status" id="fetchStatus">
            Articles fetched: <span id="fetchedCount">0</span>
        </div>
    </div>

    <!-- Indexed files section -->
    <div class="indexed-files" id="indexedFilesContainer">
        <h2>Indexed Files <span id="totalFilesCount" class="file-count-badge">0</span></h2>
        <div class="number_of_files" id="fileCountSummary">Loading files...</div>
        <div id="indexedFilesList">Loading...</div>
        <button type="button" id="deleteAllFilesButton" class="delete-button">Delete All Files</button>
        <button type="button" id="refreshFilesButton">Refresh File List</button>
    </div>

    <script>
        // Variables to store settings
        let settings = {
            apiKey: "",
            temperature: 0.7,
            maxTokens: 1000,
            numberOfFiles: 100,
            maxArticles: 100,
            files: [],
            urls: [],
            fetchDuration: 5, // In minutes
            searchQuery: ""
        };

        // Variables for fetch timer
        let fetchTimer = null;
        let fetchStartTime = null;
        let fetchEndTime = null;
        let isFetching = false;
        let fetchedArticlesCount = 0;

        // RAG status tracking
        let ragEnabled = false;
        let systemInfo = {};

        // Load system info and update RAG status
        function loadSystemInfo() {
            fetch('/system_info')
                .then(response => response.json())
                .then(data => {
                    systemInfo = data;
                    ragEnabled = data.rag_enabled;
                    updateRAGStatusIndicator();
                })
                .catch(error => {
                    console.error('Error loading system info:', error);
                });
        }

        // Update RAG status indicator
        function updateRAGStatusIndicator() {
            const indicator = document.getElementById('ragStatusIndicator');
            
            if (ragEnabled && systemInfo.rag_index_loaded) {
                const docCount = systemInfo.index_stats?.document_count || 0;
                indicator.textContent = `RAG Active (${docCount} docs)`;
                indicator.className = 'rag-status-indicator rag-active';
                indicator.style.display = 'block';
            } else if (ragEnabled && !systemInfo.rag_index_loaded) {
                indicator.textContent = 'RAG Enabled (No docs)';
                indicator.className = 'rag-status-indicator rag-pending';
                indicator.style.display = 'block';
            } else {
                indicator.style.display = 'none';
            }
        }

        // Update timer display with appropriate formatting
        function updateTimerDisplay(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const remainingSeconds = seconds % 60;
            
            let displayText = '';
            
            if (hours > 0) {
                displayText += `${hours.toString().padStart(2, '0')}:`;
            }
            
            displayText += `${minutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`;
            document.getElementById("timerDisplay").textContent = displayText;
        }

        // Update progress bar
        function updateProgressBar(percent) {
            document.getElementById("fetchProgressBar").style.width = `${percent}%`;
        }

        // Start fetch process
        function startFetchProcess() {
            // Show timer container
            document.getElementById("timerContainer").style.display = "block";
            
            // Update status
            const statusEl = document.getElementById("statusMessage");
            statusEl.textContent = "Starting article fetch process...";
            statusEl.className = "status-message";
            statusEl.style.display = "block";
            
            // Set up timer variables
            fetchStartTime = new Date().getTime();
            fetchEndTime = fetchStartTime + (settings.fetchDuration * 60 * 1000);
            fetchedArticlesCount = 0;
            document.getElementById("fetchedCount").textContent = "0";
            isFetching = true;
            
            // Disable buttons during fetch
            document.getElementById("fetchButton").disabled = true;
            document.getElementById("saveButton").disabled = true;
            document.getElementById("uploadButton").disabled = true;
            
            // Reset progress bar
            updateProgressBar(0);
            
            // Start timer to update UI
            fetchTimer = setInterval(updateFetchTimer, 1000);
            
            console.log("Fetch process started");
        }

        // Stop fetch process
        function stopFetchProcess(wasCancelled = false) {
            if (!isFetching) return;
            
            clearInterval(fetchTimer);
            isFetching = false;
            
            // Re-enable buttons
            document.getElementById("fetchButton").disabled = false;
            document.getElementById("saveButton").disabled = false;
            document.getElementById("uploadButton").disabled = false;
            
            // Update status message
            const statusEl = document.getElementById("statusMessage");
            if (wasCancelled) {
                statusEl.textContent = `Fetch process cancelled. ${fetchedArticlesCount} articles were fetched.`;
                statusEl.className = "status-message warning";
            } else {
                statusEl.textContent = `Fetch process completed. ${fetchedArticlesCount} articles were fetched.`;
                statusEl.className = "status-message success";
                
                // Show RAG activation message if articles were fetched
                if (fetchedArticlesCount > 0) {
                    setTimeout(() => {
                        const ragMessage = document.createElement('div');
                        ragMessage.className = 'status-message success';
                        ragMessage.innerHTML = `
                            <strong>💡 RAG System May Be Activated!</strong><br>
                            Your articles have been indexed. Check the chat interface - RAG may have been automatically enabled.
                        `;
                        statusEl.parentNode.insertBefore(ragMessage, statusEl.nextSibling);
                        
                        // Remove after 8 seconds
                        setTimeout(() => {
                            if (ragMessage.parentNode) {
                                ragMessage.remove();
                            }
                        }, 8000);
                    }, 2000);
                }
            }
            statusEl.style.display = "block";
            
            // Hide timer container after a delay
            setTimeout(() => {
                document.getElementById("timerContainer").style.display = "none";
            }, 3000);
            
            // Refresh system info and file list
            loadSystemInfo();
            fetchIndexedFiles();
            
            console.log("Fetch process stopped. Cancelled:", wasCancelled);
        }

        // Update fetch timer
        function updateFetchTimer() {
            if (!isFetching) return;
            
            const now = new Date().getTime();
            
            // Check if timer has expired
            if (now >= fetchEndTime) {
                clearInterval(fetchTimer);
                checkFetchStatus(true); // Final check
                return;
            }
            
            // Calculate time remaining
            const timeRemaining = Math.max(0, Math.floor((fetchEndTime - now) / 1000));
            updateTimerDisplay(timeRemaining);
            
            // Calculate progress percentage
            const totalDuration = settings.fetchDuration * 60;
            const elapsed = totalDuration - timeRemaining;
            const progressPercent = Math.min(100, Math.floor((elapsed / totalDuration) * 100));
            updateProgressBar(progressPercent);
            
            // Check with server for status update every 5 seconds
            if (elapsed % 5 === 0) {
                checkFetchStatus();
            }
        }

        // Check fetch status with server
        function checkFetchStatus(isFinal = false) {
            fetch('/fetch_status', {
                method: 'GET'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Update count
                    fetchedArticlesCount = data.count || 0;
                    document.getElementById("fetchedCount").textContent = fetchedArticlesCount;
                    
                    // Check if process has completed or was cancelled
                    if (data.status === 'completed' || data.status === 'cancelled' || !data.active) {
                        stopFetchProcess(data.status === 'cancelled');
                    }
                } else {
                    console.error("Error checking fetch status:", data);
                }
            })
            .catch(error => {
                console.error("Error connecting to fetch status endpoint:", error);
            });
        }

        // Fetch indexed files
        function fetchIndexedFiles() {
            // Show a loading state
            const filesList = document.getElementById("indexedFilesList");
            filesList.innerHTML = '<p>Loading files...</p>';
            
            document.getElementById("fileCountSummary").textContent = "Loading files...";

            // Make the API call to the backend
            fetch('/get_indexed_files', {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Render the files
                    renderIndexedFiles(data.files);
                    
                    // Update file count display
                    const fileCount = data.files.length;
                    document.getElementById("totalFilesCount").textContent = fileCount;
                    document.getElementById("fileCountSummary").textContent = 
                        fileCount > 0 ? 
                        `${fileCount} file${fileCount !== 1 ? 's' : ''} currently indexed` : 
                        "No files currently indexed";
                    
                    // Show/hide delete all button based on file count
                    document.getElementById("deleteAllFilesButton").style.display = 
                        fileCount > 0 ? 'inline-block' : 'none';
                } else {
                    // Display error message
                    const statusEl = document.getElementById("statusMessage");
                    statusEl.textContent = data.error || "Error fetching indexed files.";
                    statusEl.className = "status-message error";
                    statusEl.style.display = "block";
                    
                    // Clear the files list
                    document.getElementById("indexedFilesList").innerHTML = '<p>No files indexed.</p>';
                    document.getElementById("fileCountSummary").textContent = "Error loading files";
                    document.getElementById("totalFilesCount").textContent = "0";
                    document.getElementById("deleteAllFilesButton").style.display = 'none';
                }
            })
            .catch(error => {
                console.error("Error fetching indexed files:", error);
                
                // Display error message
                const statusEl = document.getElementById("statusMessage");
                statusEl.textContent = "Error connecting to server. Please try again.";
                statusEl.className = "status-message error";
                statusEl.style.display = "block";
                
                // Clear the files list
                document.getElementById("indexedFilesList").innerHTML = '<p>Error loading files.</p>';
                document.getElementById("fileCountSummary").textContent = "Error loading files";
                document.getElementById("totalFilesCount").textContent = "0";
            });
        }

        // Render indexed files
        function renderIndexedFiles(files) {
            const container = document.getElementById("indexedFilesList");

            if (!files || files.length === 0) {
                container.innerHTML = '<p>No files indexed.</p>';
                document.getElementById("deleteAllFilesButton").style.display = 'none';
                return;
            }

            document.getElementById("deleteAllFilesButton").style.display = 'inline-block';

            let html = '';
            
            // Sort files alphabetically
            files.sort((a, b) => {
                if (typeof a === 'string' && typeof b === 'string') {
                    return a.localeCompare(b);
                }
                // Handle object-based file data
                const fileNameA = typeof a === 'object' ? a.filename : a;
                const fileNameB = typeof b === 'object' ? b.filename : b;
                return fileNameA.localeCompare(fileNameB);
            });

            files.forEach(file => {
                // Check if file is a string or an object
                const filename = typeof file === 'object' ? file.filename : file;
                const chunks = typeof file === 'object' && file.chunks ? file.chunks : '?';
                
                html += `
                <div class="file-item">
                    <div class="file-info">
                        <span class="file-name">${filename}</span>
                        ${typeof file === 'object' ? `<span class="file-metadata">Chunks: ${chunks}</span>` : ''}
                    </div>
                    <button type="button" class="delete-button" onclick="deleteFile('${filename}')">Delete</button>
                </div>
                `;
            });

            container.innerHTML = html;
        }

        // Delete file function - needs to be in global scope for onclick
        window.deleteFile = function(filename) {
            if (confirm(`Are you sure you want to delete "${filename}"?`)) {
                // Show a loading indicator
                const statusEl = document.getElementById("statusMessage");
                statusEl.textContent = `Deleting file "${filename}"...`;
                statusEl.className = "status-message";
                statusEl.style.display = "block";
                
                // Make the API call to the backend
                fetch('/delete_file', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ filename: filename })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Update status message
                        statusEl.textContent = data.message || `File "${filename}" deleted successfully.`;
                        statusEl.className = "status-message success";
                        
                        // Refresh the files list and system info
                        fetchIndexedFiles();
                        loadSystemInfo();
                    } else {
                        // Display error message
                        statusEl.textContent = data.error || "Error deleting file.";
                        statusEl.className = "status-message error";
                        
                        // Refresh the files list just in case
                        fetchIndexedFiles();
                    }
                })
                .catch(error => {
                    console.error("Error deleting file:", error);
                    
                    // Display error message
                    statusEl.textContent = "Error connecting to server. Please try again.";
                    statusEl.className = "status-message error";
                });
            }
        };

        // Add event listeners
        document.addEventListener("DOMContentLoaded", function() {
            // Load system info initially
            loadSystemInfo();
            
            // Refresh system info periodically
            setInterval(loadSystemInfo, 30000); // Every 30 seconds
            
            // Update sliders and their displayed values
            document.getElementById("temperature").addEventListener("input", function () {
                settings.temperature = parseFloat(this.value);
                document.getElementById("temperatureValue").textContent = settings.temperature.toFixed(2);
            });

            document.getElementById("maxTokens").addEventListener("input", function () {
                settings.maxTokens = parseInt(this.value);
                document.getElementById("maxTokensValue").textContent = settings.maxTokens;
            });

            document.getElementById("numberOfFiles").addEventListener("input", function () {
                settings.numberOfFiles = parseInt(this.value);
                document.getElementById("numberOfFilesValue").textContent = settings.numberOfFiles;
            });

            document.getElementById("maxArticles").addEventListener("input", function () {
                settings.maxArticles = parseInt(this.value);
                document.getElementById("maxArticlesValue").textContent = settings.maxArticles;
            });

            // Handle API key
            document.getElementById("apiKey").addEventListener("change", function () {
                settings.apiKey = this.value;
            });

            // Handle file upload
            document.getElementById("fileUpload").addEventListener("change", function () {
                settings.files = this.files;
                document.getElementById("fileCount").textContent = settings.files.length;
            });

            // Handle URLs
            document.getElementById("urls").addEventListener("change", function () {
                settings.urls = this.value.split("\n").filter(url => url.trim() !== "");
            });

            // Handle fetch duration
            document.getElementById("fetchDuration").addEventListener("input", function () {
                settings.fetchDuration = parseInt(this.value);
                
                // Format the display text based on duration
                let displayText = "";
                if (settings.fetchDuration < 60) {
                    // Less than an hour - show minutes
                    displayText = `${settings.fetchDuration} minute${settings.fetchDuration > 1 ? 's' : ''}`;
                } else {
                    // Calculate hours and remaining minutes
                    const hours = Math.floor(settings.fetchDuration / 60);
                    const minutes = settings.fetchDuration % 60;
                    
                    if (minutes === 0) {
                        // Even hours
                        displayText = `${hours} hour${hours > 1 ? 's' : ''}`;
                    } else {
                        // Hours and minutes
                        displayText = `${hours} hour${hours > 1 ? 's' : ''} ${minutes} minute${minutes > 1 ? 's' : ''}`;
                    }
                }
                
                document.getElementById("fetchDurationDisplay").textContent = displayText;
                updateTimerDisplay(settings.fetchDuration * 60);
            });

            // Handle search query
            document.getElementById("searchQuery").addEventListener("change", function () {
                settings.searchQuery = this.value.trim();
            });

            // Navigate to home
            document.getElementById("homeButton").addEventListener("click", function () {
                window.location.href = '/home';
            });

            // Save settings
            document.getElementById("saveButton").addEventListener("click", function () {
                saveSettings();
            });

            // Upload button (separate from save settings)
            document.getElementById("uploadButton").addEventListener("click", function () {
                if (document.getElementById("fileUpload").files.length === 0) {
                    const statusEl = document.getElementById("statusMessage");
                    statusEl.textContent = "Please select files to upload first.";
                    statusEl.className = "status-message warning";
                    statusEl.style.display = "block";
                    return;
                }
                
                // Validate API Key
                if (!document.getElementById("apiKey").value.trim()) {
                    const statusEl = document.getElementById("statusMessage");
                    statusEl.textContent = "Please enter an API key before uploading files.";
                    statusEl.className = "status-message warning";
                    statusEl.style.display = "block";
                    return;
                }
                
                uploadFiles();
            });

            // Refresh files button
            document.getElementById("refreshFilesButton").addEventListener("click", function() {
                fetchIndexedFiles();
                loadSystemInfo();
            });

            // Fetch Articles Button
            document.getElementById("fetchButton").addEventListener("click", function () {
                const searchQuery = document.getElementById("searchQuery").value.trim();
                const urls = document.getElementById("urls").value.trim();
                
                if (!searchQuery && !urls) {
                    const statusEl = document.getElementById("statusMessage");
                    statusEl.textContent = "Please provide either a search query or URLs to fetch articles.";
                    statusEl.className = "status-message warning";
                    statusEl.style.display = "block";
                    return;
                }
                
                // Validate API Key
                if (!document.getElementById("apiKey").value.trim()) {
                    const statusEl = document.getElementById("statusMessage");
                    statusEl.textContent = "Please enter an API key before fetching articles.";
                    statusEl.className = "status-message warning";
                    statusEl.style.display = "block";
                    return;
                }
                
                // Start the fetch process UI
                startFetchProcess();
                
                // Prepare the data to send
                const formData = new FormData();
                formData.append("searchQuery", searchQuery);
                formData.append("urls", urls);
                formData.append("fetchDuration", parseInt(document.getElementById("fetchDuration").value));
                formData.append("maxArticles", parseInt(document.getElementById("maxArticles").value));
                formData.append("apiKey", document.getElementById("apiKey").value);
                
                // Start the server-side fetch process
                fetch('/fetch_articles', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Update fetch status
                        if (data.status === 'started') {
                            // The backend has started the fetch process
                            // The UI will continue to update via timer
                            console.log("Fetch process started on server");
                        } else if (data.status === 'completed') {
                            // The process completed immediately (for small number of URLs)
                            fetchedArticlesCount = data.count || 0;
                            document.getElementById("fetchedCount").textContent = fetchedArticlesCount;
                            stopFetchProcess();
                        }
                    } else {
                        // There was an error
                        const statusEl = document.getElementById("statusMessage");
                        statusEl.textContent = data.message || "Error starting fetch process.";
                        statusEl.className = "status-message error";
                        statusEl.style.display = "block";
                        
                        // Stop the fetch process UI
                        stopFetchProcess(true);
                    }
                })
                .catch(error => {
                    console.error("Error starting fetch process:", error);
                    
                    // Display error message
                    const statusEl = document.getElementById("statusMessage");
                    statusEl.textContent = "Error connecting to server. Please try again.";
                    statusEl.className = "status-message error";
                    statusEl.style.display = "block";
                    
                    // Stop the fetch process UI
                    stopFetchProcess(true);
                });
            });

            // Cancel fetch button
            document.getElementById("cancelFetchButton").addEventListener("click", function() {
                if (!isFetching) return;
                
                // Show cancellation message
                const statusEl = document.getElementById("statusMessage");
                statusEl.textContent = "Cancelling fetch process...";
                statusEl.className = "status-message warning";
                statusEl.style.display = "block";
                
                // Send cancel request to server
                fetch('/cancel_fetch', {
                    method: 'POST'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        console.log("Fetch cancellation requested");
                    } else {
                        console.error("Error cancelling fetch:", data);
                        // Still stop the UI process even if server reports an error
                        stopFetchProcess(true);
                    }
                })
                .catch(error => {
                    console.error("Error connecting to cancel endpoint:", error);
                    stopFetchProcess(true);
                });
            });

            // Delete all files
            document.getElementById("deleteAllFilesButton").addEventListener("click", function () {
                if (confirm("Are you sure you want to delete ALL indexed files? This cannot be undone!")) {
                    // Show a loading indicator
                    const statusEl = document.getElementById("statusMessage");
                    statusEl.textContent = "Deleting all files...";
                    statusEl.className = "status-message";
                    statusEl.style.display = "block";
                    
                    // Make the API call to the backend
                    fetch('/delete_all_files', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // Update status message
                            statusEl.textContent = data.message || "All files deleted successfully.";
                            statusEl.className = "status-message success";
                            
                            // Clear the files list
                            document.getElementById("indexedFilesList").innerHTML = '<p>No files indexed.</p>';
                            document.getElementById("fileCountSummary").textContent = "No files indexed";
                            document.getElementById("totalFilesCount").textContent = "0";
                            document.getElementById("deleteAllFilesButton").style.display = 'none';
                            
                            // Refresh system info
                            loadSystemInfo();
                        } else {
                            // Display error message
                            statusEl.textContent = data.error || "Error deleting files.";
                            statusEl.className = "status-message error";
                            
                            // Refresh the files list just in case
                            fetchIndexedFiles();
                        }
                    })
                    .catch(error => {
                        console.error("Error deleting all files:", error);
                        
                        // Display error message
                        statusEl.textContent = "Error connecting to server. Please try again.";
                        statusEl.className = "status-message error";
                    });
                }
            });
        });

        // Functions for saving settings and uploading files
        function saveSettings() {
            // Validate API Key
            if (!document.getElementById("apiKey").value.trim()) {
                const statusEl = document.getElementById("statusMessage");
                statusEl.textContent = "Please enter an API key.";
                statusEl.className = "status-message warning";
                statusEl.style.display = "block";
                return;
            }
            
            // Create FormData object
            const formData = new FormData();

            // Add settings to FormData
            formData.append("apiKey", document.getElementById("apiKey").value);
            formData.append("temperature", document.getElementById("temperature").value);
            formData.append("maxTokens", document.getElementById("maxTokens").value);
            formData.append("numberOfFiles", document.getElementById("numberOfFiles").value);
            formData.append("maxArticles", document.getElementById("maxArticles").value);

            // Send data to server
            fetch('/save_api_settings', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                const statusEl = document.getElementById("statusMessage");
                
                if (data.success) {
                    // Show success message
                    let successMsg = "Settings saved successfully.";
                    
                    if (data.rag_auto_enabled) {
                        successMsg += " RAG has been automatically enabled!";
                    }
                    
                    statusEl.textContent = successMsg;
                    statusEl.className = "status-message success";
                    statusEl.style.display = "block";

                    // Save to localStorage as well
                    localStorage.setItem("apiSettings", JSON.stringify({
                        apiKey: document.getElementById("apiKey").value,
                        temperature: parseFloat(document.getElementById("temperature").value),
                        maxTokens: parseInt(document.getElementById("maxTokens").value),
                        numberOfFiles: parseInt(document.getElementById("numberOfFiles").value),
                        maxArticles: parseInt(document.getElementById("maxArticles").value),
                        fetchDuration: parseInt(document.getElementById("fetchDuration").value),
                        searchQuery: document.getElementById("searchQuery").value
                    }));

                    // Refresh system info
                    loadSystemInfo();

                    console.log("Settings saved successfully");
                } else {
                    // Show error message
                    statusEl.textContent = data.error || "Error saving settings.";
                    statusEl.className = "status-message error";
                    statusEl.style.display = "block";
                    console.error("Error saving settings:", data.error);
                }
            })
            .catch(error => {
                // Show error message
                const statusEl = document.getElementById("statusMessage");
                statusEl.textContent = "Error saving settings: " + error.message;
                statusEl.className = "status-message error";
                statusEl.style.display = "block";

                console.error("Error saving settings:", error);
            });
        }

        function uploadFiles() {
            // Create FormData object for file uploads
            const formData = new FormData();
            
            // Add the API key and number of files
            formData.append("apiKey", document.getElementById("apiKey").value);
            formData.append("numberOfFiles", document.getElementById("numberOfFiles").value);
            
            // Add files to FormData
            const fileInput = document.getElementById("fileUpload");
            if (fileInput.files.length > 0) {
                for (let i = 0; i < fileInput.files.length; i++) {
                    formData.append("files[]", fileInput.files[i]);
                }
            }
            
            // Show uploading message
            const statusEl = document.getElementById("statusMessage");
            statusEl.textContent = `Uploading ${fileInput.files.length} file(s)...`;
            statusEl.className = "status-message";
            statusEl.style.display = "block";
            
            // Disable the upload button
            document.getElementById("uploadButton").disabled = true;
            
            // Send data to server
            fetch('/save_api_settings', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                // Re-enable the upload button
                document.getElementById("uploadButton").disabled = false;
                
                if (data.success) {
                    // Show success message with RAG info
                    let successMsg = `Successfully uploaded and indexed ${fileInput.files.length} file(s).`;
                    
                    if (data.rag_auto_enabled) {
                        successMsg += " RAG has been automatically enabled!";
                    }
                    
                    statusEl.textContent = successMsg;
                    statusEl.className = "status-message success";
                    
                    // Reset file input
                    fileInput.value = "";
                    document.getElementById("fileCount").textContent = "0";
                    
                    // Refresh indexed files list and system info
                    fetchIndexedFiles();
                    loadSystemInfo();
                    
                    // Show additional message about RAG if it was auto-enabled
                    if (data.rag_auto_enabled) {
                        setTimeout(() => {
                            const ragMessage = document.createElement('div');
                            ragMessage.className = 'status-message success';
                            ragMessage.innerHTML = `
                                <strong>💡 RAG System Activated!</strong><br>
                                Your documents are now available for intelligent Q&A. 
                                Return to the chat to ask questions about your uploaded content.
                            `;
                            statusEl.parentNode.insertBefore(ragMessage, statusEl.nextSibling);
                            
                            // Remove after 8 seconds
                            setTimeout(() => {
                                if (ragMessage.parentNode) {
                                    ragMessage.remove();
                                }
                            }, 8000);
                        }, 2000);
                    }
                } else {
                    // Show error message
                    statusEl.textContent = data.error || "Error uploading files.";
                    statusEl.className = "status-message error";
                }
            })
            .catch(error => {
                // Re-enable the upload button
                document.getElementById("uploadButton").disabled = false;
                
                // Show error message
                statusEl.textContent = "Error connecting to server: " + error.message;
                statusEl.className = "status-message error";
                console.error("Upload error:", error);
            });
        }

        // Initialize application
        window.addEventListener("load", function () {
            // Load settings from localStorage if available
            const savedSettings = localStorage.getItem("apiSettings");
            if (savedSettings) {
                try {
                    const parsed = JSON.parse(savedSettings);

                    if (parsed.apiKey) {
                        document.getElementById("apiKey").value = parsed.apiKey;
                        settings.apiKey = parsed.apiKey;
                    }

                    if (parsed.temperature) {
                        document.getElementById("temperature").value = parsed.temperature;
                        document.getElementById("temperatureValue").textContent = parsed.temperature.toFixed(2);
                        settings.temperature = parsed.temperature;
                    }

                    if (parsed.maxTokens) {
                        document.getElementById("maxTokens").value = parsed.maxTokens;
                        document.getElementById("maxTokensValue").textContent = parsed.maxTokens;
                        settings.maxTokens = parsed.maxTokens;
                    }
                    
                    if (parsed.numberOfFiles) {
                        document.getElementById("numberOfFiles").value = parsed.numberOfFiles;
                        document.getElementById("numberOfFilesValue").textContent = parsed.numberOfFiles;
                        settings.numberOfFiles = parsed.numberOfFiles;
                    }
                    
                    if (parsed.maxArticles) {
                        document.getElementById("maxArticles").value = parsed.maxArticles;
                        document.getElementById("maxArticlesValue").textContent = parsed.maxArticles;
                        settings.maxArticles = parsed.maxArticles;
                    }

                    if (parsed.fetchDuration) {
                        document.getElementById("fetchDuration").value = parsed.fetchDuration;
                        settings.fetchDuration = parsed.fetchDuration;
                        
                        // Update display text
                        let displayText = "";
                        if (settings.fetchDuration < 60) {
                            displayText = `${settings.fetchDuration} minute${settings.fetchDuration > 1 ? 's' : ''}`;
                        } else {
                            const hours = Math.floor(settings.fetchDuration / 60);
                            const minutes = settings.fetchDuration % 60;
                            
                            if (minutes === 0) {
                                displayText = `${hours} hour${hours > 1 ? 's' : ''}`;
                            } else {
                                displayText = `${hours} hour${hours > 1 ? 's' : ''} ${minutes} minute${minutes > 1 ? 's' : ''}`;
                            }
                        }
                        document.getElementById("fetchDurationDisplay").textContent = displayText;
                    }
                    
                    if (parsed.searchQuery) {
                        document.getElementById("searchQuery").value = parsed.searchQuery;
                        settings.searchQuery = parsed.searchQuery;
                    }
                } catch (error) {
                    console.error("Error parsing saved settings:", error);
                }
            }
            
            // Initialize timer display
            updateTimerDisplay(settings.fetchDuration * 60);
            
            // Load system info and fetch indexed files
            loadSystemInfo();
            fetchIndexedFiles();
            
            // Check for active fetch process
            checkFetchStatus();
        });
    </script>
</body>

</html>